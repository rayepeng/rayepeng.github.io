---
interface Props {
  class?: string;
}

const { class: className } = Astro.props;
---

<div class={className}>
  <div id="remark42"></div>
</div>

<script>
  // 全局 Remark42 配置
  if (!window.remark_config) {
    window.remark_config = {
      host: "https://comment.rayepeng.net",
      site_id: "blog",
      // url 会在创建实例时动态设置，作为评论的唯一标识
    };
  }

  // 存储当前的 Remark42 实例
  let remark42Instance = null;

  // 加载 Remark42 脚本（仅首次加载）
  function loadRemark42Script() {
    if (window.REMARK42 || document.querySelector('script[src*="remark42"]')) {
      return;
    }
    
    const components = ['embed'];
    components.forEach((component) => {
      const script = document.createElement('script');
      script.src = `${window.remark_config.host}/web/${component}.js`;
      script.defer = true;
      (document.head || document.body).appendChild(script);
    });
  }

  // 初始化 Remark42 实例
  function initRemark42() {
    const node = document.getElementById('remark42');
    if (!node) return;

    // 销毁旧实例
    if (remark42Instance) {
      try {
        remark42Instance.destroy();
      } catch (e) {
        console.warn('Failed to destroy previous Remark42 instance:', e);
      }
      remark42Instance = null;
    }

    // 创建新实例
    if (window.REMARK42) {
      remark42Instance = window.REMARK42.createInstance({
        node: node,
        host: window.remark_config.host,
        site_id: window.remark_config.site_id,
        // url 使用当前页面路径作为唯一标识
        url: window.location.origin + window.location.pathname,
      });
    }
  }

  // 首次加载
  loadRemark42Script();

  // 等待 REMARK42 准备就绪
  if (window.REMARK42) {
    initRemark42();
  } else {
    window.addEventListener('REMARK42::ready', () => {
      initRemark42();
    });
  }

  // 处理 Swup 页面切换
  const setupSwup = () => {
    if (window.swup) {
      // 页面切换时重新初始化
      window.swup.hooks.on('page:view', () => {
        if (document.getElementById('remark42')) {
          initRemark42();
        }
      });

      // 页面离开前销毁实例
      window.swup.hooks.on('visit:start', () => {
        if (remark42Instance) {
          try {
            remark42Instance.destroy();
          } catch (e) {
            console.warn('Failed to destroy Remark42 instance on route leave:', e);
          }
          remark42Instance = null;
        }
      });
    }
  };

  if (window.swup) {
    setupSwup();
  } else {
    document.addEventListener('swup:enable', setupSwup);
  }
</script>

